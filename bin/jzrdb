#!/usr/bin/env bash
# set -euo pipefail
# set -eo pipefail

home="$(realpath "$(realpath "${BASH_SOURCE[0]}" | xargs dirname)"/..)"; cd "$home"

#...........................................................................................................
path_to_pspg=pspg

#...........................................................................................................
if command -v nodexh &>/dev/null; then
  path_to_node=nodexh
else
  path_to_node=node
fi

#-----------------------------------------------------------------------------------------------------------
pipe_or_fail() {
  local tmp rc
  tmp=$(mktemp) || return 1
  #.........................................................................................................
  local -a prod=()
  local -a cons=()
  local mode=prod
  #.........................................................................................................
  for arg in "$@"; do
    if [[ $arg == -- && $mode == prod ]]; then
      mode=cons
      continue
    fi
    if [[ $mode == prod ]]; then
      prod+=("$arg")
    else
      cons+=("$arg")
    fi
  done
  #.........................................................................................................
  # sanity check
  if ((${#prod[@]} == 0 || ${#cons[@]} == 0)); then
    echo "pipe_or_fail: missing producer or consumer" >&2
    rm -f "$tmp"
    return 2
  fi
  #.........................................................................................................
  # run producer
  if "${prod[@]}" >"$tmp"; then
    "${cons[@]}" <"$tmp"
    rc=$?
  else
    rc=$?
  fi
  #.........................................................................................................
  rm -f "$tmp"
  return "$rc"
}


#...........................................................................................................
pipe_or_fail "$path_to_node" ./lib/main.js "$@" -- "$path_to_pspg" -s6 --csv --csv-header=on --double-header
# "$path_to_node" ./lib/main.js "$@"

