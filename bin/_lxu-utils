#!/usr/bin/env bash
set -euo pipefail

#-----------------------------------------------------------------------------------------------------------
enodir() {
  # path="$1"
  # echo "no such directory: $path"
  exit 1; }

#-----------------------------------------------------------------------------------------------------------
enocmd() {
  name="$1"
  echo "executable not found: $name"
  exit 1; }

#-----------------------------------------------------------------------------------------------------------
realpath() {
  # thx to https://github.com/whatwg/html-build/issues/90
  OURPWD=$PWD
  cd "$(dirname "$1")" || enodir
  LINK=$(readlink "$(basename "$1")")
  while [ "$LINK" ]; do
    cd "$(dirname "$LINK")" || enodir
    LINK=$(readlink "$(basename "$1")")
  done
  REALPATH="$PWD/$(basename "$1")"
  cd "$OURPWD" || enodir
  echo "$REALPATH"
}
# realpath "$@"

# #-----------------------------------------------------------------------------------------------------------
# cwd=$(pwd)
# home="$(realpath "$(realpath "${BASH_SOURCE[0]}" | xargs dirname)"/..)"; cd "$home" || enodir


#-----------------------------------------------------------------------------------------------------------
# thx to https://chatgpt.com/s/t_6942f8bb1740819187963acd9603fc3d
pipe_or_fail() {
  local tmp rc
  tmp=$(mktemp) || return 1
  #.........................................................................................................
  local -a prod=()
  local -a cons=()
  local mode=prod
  #.........................................................................................................
  for arg in "$@"; do
    if [[ $arg == -- && $mode == prod ]]; then
      mode=cons
      continue
    fi
    if [[ $mode == prod ]]; then
      prod+=("$arg")
    else
      cons+=("$arg")
    fi
  done
  #.........................................................................................................
  # sanity check
  if ((${#prod[@]} == 0 || ${#cons[@]} == 0)); then
    echo "pipe_or_fail: missing producer or consumer" >&2
    rm -f "$tmp"
    return 2
  fi
  #.........................................................................................................
  # run producer
  if "${prod[@]}" >"$tmp"; then
    # read first line of $tmp file;
    #   if it starts with the pattern given, use pager;
    #   otherwise, just print it out.
    #.......................................................................................................
    cmd_use_pspg_re='^Ω\s*command:\s*use-pspg\s*Ω$'
    #.......................................................................................................
    IFS= read -r first_line <"$tmp"
    #.......................................................................................................
    if [[ $first_line =~ $cmd_use_pspg_re ]]; then
      tail -n +2 "$tmp" | "${cons[@]}"
    else
      cat "$tmp"
      fi
    # "${cons[@]}" <"$tmp"
    rc=$?
  else
    rc=$?
  fi
  #.........................................................................................................
  rm -f "$tmp"
  return "$rc"
}
